
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <title>Image Upload and Preview</title>

    <link rel="stylesheet" href="{% static 'css/uploadImg.css' %}"> <!--center the images-->
    <link rel="stylesheet" href="{% static 'css/rmbg.css' %}">
    <link rel="stylesheet" href="{% static 'css/bg_insert.css' %}">
    <link rel="stylesheet" href="{% static 'css/canvasStyle.css' %}">
    <link rel="stylesheet" href="{% static 'css/canvas-selection.css' %}">
    <link rel="stylesheet" href="{% static 'css/text_edit.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    

</head>
<body>
    {% csrf_token %}

    {% if user.is_authenticated %}
        <div class="user-nav">
            <!-- Debug info (left side) -->
            <div class="debug-info">
                <span id="latest_upload_id">Project No.{{latest_upload_id}}</span>
                <span> â€¢ User: <strong>{{ user.username }}</strong> (ID: <strong>{{user.id}}</strong>)</span>
            </div>
            
            <!-- Navigation buttons (right side) -->
            <div class="nav-actions">
                <!-- Recent Projects button -->
                <a href="{% url 'recent_projects' %}" class="nav-btn nav-btn-secondary">
                    <i class="fa fa-history"></i>Recent Projects
                </a>
                
                <!-- Account dropdown -->
                <div class="account-dropdown">
                    <button class="nav-btn nav-btn-primary">
                        <i class="fa fa-user-circle"></i>{{ user.username }}
                    </button>
                    <div class="account-dropdown-content">
                        <div class="dropdown-header">
                            <div id="usage-display">
                                sample - This Month: 3/500 images
                            </div>
                        </div>
                        <div class="dropdown-items-container">
                            <a href="{% url 'billing_portal' %}" class="dropdown-item">
                                <i class="fa fa-credit-card"></i>Manage Subscription
                            </a>
                            <a href="{% url 'logout' %}" class="dropdown-item">
                                <i class="fa fa-sign-out"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    {% if messages %}
    <div class="alert alert-danger">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
    {% endif %}

   
        
    {% if message %}
    <div style="color: red;">{{ message }}</div>
    {% endif %}

    <!--Tool Bar-->
    <div class="tool-bar" id="tool_bar">
        <ul>
            <!-- <li onclick="Background_Insert()">BG Insert</li> -->
            <li id="Background_Insert">BG Insert</li> 
            <li onclick="textBtn()">Design</li>
            <li class="dropdown" onclick="toggleDropdown(event)">
                <span id="shadowBtn">Shadow</span>
                <div class="dropdown-content">

                    <label for="shadow-offset-y">Shadow Offset:</label> 
                    <input type="range" id="shadow-offset-y" min="5" max="50" value="20"> <!-- JS code at the bottom-->
                    <span id="offset-y-value" style="color: gray;"> 20</span>

                    <label for="shadow-blur">Shadow Blur:</label>
                    <input type="range" id="shadow-blur" min="0" max="50" value="20"> <!-- JS code at the bottom-->
                    <span id="blur-value" style="color: gray;"> 20</span>
                    <br>
                    <button id="cancelShadow"> reset </button>
                    <br><br>
                    <button class="saveChanges"> Save Changes</button>
                    <br>
            

                </div>
            </li>
            
            <li id="template">
                Template
                <div id="template-dropdown" class="dropdown-content" style="display: none;">
                    <div id="template-list"></div>
                </div>
            </li>

            <li onclick="location.href='{% url  'uploadImg' %}'">New Project</li>
            <li id="exportImages">Export</li>
        </ul>
    </div>

    <div id="main_preview" style="display: block;">
        <button id="saveChanges" class="saveChanges"> Save Changes</button>
        <h1>Preview</h1>
    </div>

    <div  style="display:none ;"> <!-- Preview for Edit TODO -->
        <div id="enlarged-image-container" class="enlarged-container" style="display: none;">
            <button id="close-button" class="close-button">âœ–</button> <!-- Close button -->
            <img id="enlarged-image" src="" alt="Enlarged Image" />
        </div>

        <!--When individual image clicked-->
        <div id="image-edit-page" style="display: none;"> 
            <div id="img_tool_bar">
                <ul>
                    <li id="Edit_Image_Btn">Edit Image</li>
                    <li>Transform</li>
                    <li id="cancel">Cancel</li>
                </ul>
            </div>
        </div>  

    </div>

    <!--Start implementing canvas shadow -->
    <div id="select-canvas" style="display: none;">
        <h1>Select Picture(s)</h1>
        <button class="nextBtn backToMain">Back</button>
        <button class="nextBtn" id="selectAllBtn">Select All</button>
        <button class="nextBtn" id="nextTextBtn">Next</button>
        <br>
        <br>
    </div>
    

    <div id="no_container" >
        <!-- Main Preview of Canvases -->
        {%if sorted_rembg_files_path%}
            <div id="rmbg_images" class="canvas-container" style="display: block;"> 
                {% for rembg_path in sorted_rembg_files_path %}
                            <span class="clickable-image canvas-item canvas-wrapper" data-path="{{ rembg_path }}">
                                <canvas class="rembg-canvas"  style=" border: 1px solid #ccc; box-shadow: none;"></canvas>
                                <img src="{{ rembg_path}}" alt="image"  class="png-img" data-path="{{ rembg_path }}"
                                style="display:none; width: 500px;" /><!-- getting image src with data-path on Canvases-->  
                                <div class="checkmark" style="display: none;">âœ”</div> <!-- Checkmark -->
                            </span>
                {% endfor %} 
            </div>
        {% else %}
             <div style="margin: 100px auto; text-align: center;">
                    <p style="font-size: 1.4rem; color: #333; margin-bottom: 30px;">
                       Please upload an image to begin.
                    </p>
                    <a href="{% url 'uploadImg' %}" 
                    style="background-color: #1b5e95;
                            color: white;
                            padding: 14px 28px;
                            font-size: 1.2rem;
                            font-weight: 600;
                            text-decoration: none;
                            border-radius: 8px;
                            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                            transition: background-color 0.3s ease;">
                        ðŸš€ CLICK HERE TO GET STARTED
                    </a>
                </div>

        {% endif %}

        <!-- Text Edit Right Side: Static Content -->
        <div id="static-content" style="display: none;">
            <button class="nextBtn backToMain" >Exit</button>
            <!-- Add this to your image editing interface -->

            
            <!-- For text components -->
            <button id="saveTextBtn" class="nextBtn">Save Design</button>

            <div class="line"></div>
            <h1 style="color:#9db7d2;">EDITOR</h1>
            
            <!-- Create a template -->
            <!-- Add this inside the static-content div, replacing the existing "Create a Template" text -->
            <div id="template-creation-modal" style="display: none;">
                <div class="template-modal-content">
                    <h2 style="margin-bottom: 10px;">Create New Template</h2>
                    
                    <div class="template-form-group">
                        
                        <input type="text" id="template-title" placeholder="Enter template name" autocomplete="off">
                    </div>
                    
                    <div class="template-form-group">
                        <label>
                            <input type="checkbox" id="include-background"> Background
                        </label>
                    </div>
                    
                    <div class="template-form-buttons">
                        <button id="save-template-btn" class="template-btn">Save</button>
                        <button id="cancel-template-btn" class="template-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <p id="create-template-btn" style="text-align:center; padding:5px; cursor: pointer;">Create a Template</p>
            
            <!-- End create a template -->

             <!-- Upload Logo Start -->
             <div class="logo-upload-container" style="text-align: center; margin: 10px auto;">
                <label for="logo-upload">Upload Logo</label>
                <input type="file" class="logo-upload" id="logo-upload" accept=".png, .jpg, .jpeg">
                <button id="select-logo-btn"  class="fa fa-caret-down" 
                style="
                margin-left: 10px;
                padding: 5px 10px;
                background: #f8f9fa;
                border: 1px solid #007bff;
                cursor: pointer;
                border-radius: 10px;
                color: #1b5e95;
                "></button>
                <span id="resetLogoInput" style="cursor: pointer; color: #fff; font-weight: bold; font-size: 20px; padding: 4px;">âœ•</span>
            </div>
            <!-- Upload Logo END -->
            
            <!-- Logo Select Start-->
            <!-- Inside the static-content div in rmbg.html -->
            <div id="logo-selector-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; display: flex; justify-content: center; align-items: center;">
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 80%; max-height: 80%; overflow-y: auto;">
                    <h3>Select a Logo</h3>
                    <div id="logo-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px;">
                        <!-- Logos will be loaded here -->
                    </div>
                    <button id="cancel-logo-select" style="margin-top: 15px; padding: 5px 15px;">Cancel</button>
                </div>
            </div>
            <!-- Logo Select END-->


            <div class="grid-container" >
            <!-- Header Bar Start -->
            <div class="grid-item" style="text-align:left; margin: 10px;">
                <h3>Header</h3>
                <label for="header-height">Height:</label>
                <input type="range" id="header-height" min="0" max="200" value="0">
                <span id="header-height-value">0</span>

                <label for="header-color">Color:</label>
                <input type="color" id="header-color" value="#000000">
                <div>
                    <label for="header-opacity">Opacity:</label>
                    <input type="range" id="header-opacity" min="0" max="1" step="0.1" value="1">
                    <span id="header-opacity-value">1</span>
                </div>
            </div>
            <!-- Header Bar END -->

            <!-- Footer Bar, Color Pick and Opacity-->
            <div class="grid-item" style="text-align: left; margin: 10px;">
                <h3> Footer </h3>
                <label for="footer-height">Height:</label>
                <input type="range" id="footer-height" min="0" max="200" value="0">
                <span id="footer-height-value">0</span>
                
                <label for="footer-color">Color:</label>
                <input type="color" id="footer-color" value="#000000">
                <div>
                    <label for="footer-opacity">Opacity:</label>
                    <input type="range" id="footer-opacity" min="0" max="1" step="0.1" value="1">
                    <span id="footer-opacity-value">1</span>
                </div>
            </div>
            <!--Footer Settings END-->
            </div>
            <!-- text START -->
            <div style="width: 100%;" >
                <div id="footer-text-controls" style="text-align: center; margin: 10px auto;">
                    
                    <button id="add-text-btn-footer" style="padding: 5px; margin: 5px;"><span id="plus-sign">+</span> Add Text</button>
                </div>

                <div id="footer-text-list" style="margin: 10px auto; text-align: center;">
                    <!-- Dynamic text input sections will be added here -->
                </div>
            </div>

        </div>
    </div>




    <!-- background insert page -->
    <div id="bg_images" style="display: none;">
        
        <button class="nextBtn" id="backToMainBtn" >Back</button>
        <button class="nextBtn" id="submitBtn" >Apply</button>
        
        
       <!--"Background insert" pictures -->
        <h1>Choose your backgrond</h1>

        <hr>
        <!-- templates/upload_background.html -->
        <div id="upload_your_bg" style="cursor:pointer;">
            <label for="bgUpload" class="custom-upload" style="color:#7794aa; cursor:pointer;"> <i class="fa fa-upload"></i><u>Upload your background </u> </label>
            <input type="file" id="bgUpload" accept="image/*" multiple style="display: none;"/>
            <br>
            <br>
            <!-- Preview for uploaded bg image-->
        
            <div class="container">
                <div class="image-grid">
                    {% for bg_path in user_backgrounds %}
                    <div class="picture">
                        <img src="{{ bg_path }}" alt="{{ bg_path }}">
                        <div class="checkmark">âœ”</div>
                        <button class="delete-btn" style="color: rgb(212, 143, 143); background:white; border:aquamarine; cursor:pointer;">X</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <!-- Handling deletion of user BG image-->
            <!-- Confirmation Modal -->
            <div id="confirmationModal" class="modal hidden">
            <div class="modal-content">
                <p id="modalMessage">Are you sure you want to delete this background image?</p>
                <div class="modal-buttons">
                <button id="confirmDelete" class="btn btn-danger">Delete</button>
                <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
            </div>
            <!-- END Handling deletion of user BG image-->

            <script>
            document.getElementById('bgUpload').addEventListener('change', function () {
                const files = this.files;
                const container = document.querySelector('.image-grid');

               // Loop over each selected file
                Array.from(files).forEach(file => {
                    const formData = new FormData();
                    formData.append('image', file);

                    fetch('/upload-background/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCSRFToken(), // protect against CSRF
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.url) {
                            // Create <div class="picture"> element
                            const div = document.createElement('div');
                            div.className = 'picture';
                           

                            const img = document.createElement('img');
                            img.src = data.url;
                            img.alt = data.url;

                            const checkmark = document.createElement('div');
                            checkmark.className = 'checkmark';
                            checkmark.textContent = 'âœ”';

                            const delete_btn = document.createElement('button')
                            delete_btn.className = 'delete-btn';
                            delete_btn.textContent  = 'X';
                            delete_btn.style.color = 'rgb(212, 143, 143)';
                            delete_btn.style.background = 'white';
                            delete_btn.style.border = 'aquamarine';
                            delete_btn.style.cursor = 'pointer';

                            div.appendChild(img);
                            div.appendChild(checkmark);
                            div.appendChild(delete_btn);
                            container.appendChild(div); // âœ… Add new image to the container
                            
                        }
                    });
                });

                function getCSRFToken() {
                    const cookieValue = document.cookie
                        .split('; ')
                        .find(row => row.startsWith('csrftoken='));
                    return cookieValue ? cookieValue.split('=')[1] : '';
                }
            });
            </script>
        </div>    
        <!-- END templates/upload_background.html -->
        <hr>
        
        <div class="container">
            <div class="image-grid">
                {% for bg_path in bg_img_paths %}
                        <div class="picture"><img src={{bg_path}} alt={{bg_path}} /> 
                            <div class="checkmark">âœ”</div>
                        </div> 
                {% endfor %}
            </div>
        </div>
        <hr>
        <h1>Garage</h1>
        <div class="container">
            <div class="image-grid">
                {% for bg_path in bg_img_paths_garage %}
                        <div class="picture"><img src={{bg_path}} alt={{bg_path}} /> 
                            <div class="checkmark">âœ”</div>
                        </div> 
                {% endfor %}
            </div>
        </div>

        <hr>
        <h1>Road</h1>
        <div class="container">
            <div class="image-grid">
                {% for bg_path in bg_img_paths_road %}
                        <div class="picture"><img src={{bg_path}} alt={{bg_path}} /> 
                            <div class="checkmark">âœ”</div>
                        </div> 
                {% endfor %}
            </div>
        </div>
        <hr>
    </div>  

    <!--Error message Start-->
    <div id="error-message" class="hidden" style="margin-top: 50px;">
        <span id="error-text"></span>
        <button id="dismiss-btn" class="dismiss-btn">&times;</button>
    </div>
    <!--Error message  END-->


    <!--Edit Image Start -->
    <div id="canvasPage" style="display:none;">
        <h1> Edit Image</h1>
      

        <div id="field">
            <div class="top-controls-container"
                style="
                    display: flex; /* Flex container */
                    justify-content: space-between; /* Align left and right */
                    align-items: center; /* Vertically center items */
                    padding: 10px; /* Add padding */
                    width: 100%; /* Full width of the field */
                    box-sizing: border-box; /* Ensure padding doesn't break the width */
                ">

                    <div class="top-toolbar-container"
                    style="
                    display: flex; /* Use Flexbox for layout */
                    justify-content: flex-start; /* Align items to the left */
                    align-items: center; /* Center items vertically */
                    padding: 10px; /* Add padding */
                    ">
                <div class="top-tools">
                    <button onclick="redo_last()" type="button" class="button">Redo <b>â†º</b></button>
                    <button onclick="undo_last()" type="button" class="button">Undo <b>â†»</b></button>
                    <button onclick="clear_canvas()" type="button" class="button">Clear</button>
                </div>

                <div class="backgroundSelect"
                style="margin-left: 20px;">
                    <select id="background-color" onchange="changeBackgroundColor(this.value)"
                    style="
                        background-color: rgb(212, 212, 212);
                        font-size: medium;
                    ">
                        <option value="#252525" selected>Dark Gray</option>
                        <option value="lightgray">Light Gray</option>
                        <option value="white">White</option>
                        <option value="black">Black</option>
                    </select>
                </div>
            </div>

            <div class="top-save-control"
            style="
                display: flex; /* Use Flexbox for layout */
                justify-content: flex-end; /* Align items to the right */
                align-items: center; /* Center items vertically */
            ">
                    <button id="saveImage" type="button" class="buttonSave" name="saveBTN">
                        Save
                    </button>
                    <button type="button" onclick="backToMainBtn()" class="buttonSave dontsave">
                        Exit without saving
                    </button>
                
            </div>

        </div>


        <!-- Canvas and Tools-->
        <canvas id="canvas" width="900" ></canvas>

        <div class="tools">

            <button onclick="useEraser()" type="button" class="button">Erase</button>
            <button onclick="useRestore()" type="button" class="button">Restore </button>

            <input 
                oninput="updateCursorWidth(this.value)"
                type="range" 
                min="2" max="100" 
                class="pen-range"
                value = "50"
                >

            <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg" 
            style="
            display: none;
            /*display: flex;*/
            background-color: black; 
            border:2px dotted white; 
            justify-content: center;
            margin-top: 15px;
            ">
                <circle cx="20" cy="20" r="20" stroke="white" stroke-width="2" fill="none" />
            </svg>
                
    
            </div>
        </div>
    
    </div>
    <!--Edit Image End -->


    <!--Edit image js src-->
    <script type="text/javascript" src="{% static 'canvasJavascript.js' %}">
    </script>

    <!--Load canvas.js  -->
    <script type="text/javascript" src="{% static 'canvas.js' %}" defer>
    </script>

    <script type="module" src="{% static 'main_preview/canvas_mouse.js' %}" defer></script>
    <!-- Load rmbg.js  -->
    <script type="text/javascript" src="{% static 'rmbg.js' %}" defer>
    </script>

    <!-- Load zip jszip.js.js -->
    <script type="text/javascript" src="static/jszip.js">
    </script> 
    


    <!-- Code for canvas --> 
    <script>
        // Update your JavaScript to send the JSON to the server using fetch
        
        // function saveChanges(){

        //     //console.log("save btn pressed");
        //     const finalMetadataArray = Array.from(metadataMap.values()); // metadataMap 
        //     console.log(finalMetadataArray);
            
        //     // Fetch POST to save sqlite database

        //     fetch('save_metadata', {  // Adjust URL based on your Django URL structure
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             'X-CSRFToken': getCSRFToken() // Include CSRF token
        //         },
        //         body: JSON.stringify({ metadata:finalMetadataArray }) 
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         console.log("Response from server:", data);
        //         showError("Saved", "green")
             
        //     })
        //     .catch(error => {
        //         console.error("Error saving metadata:", error);
        //         showError("Error saving metadata: " + error, "red");
        //     });
        // }

        // // Function to get CSRF token from Django's cookies
        // function getCSRFToken() {
        //     const cookieValue = document.cookie.match(/csrftoken=([^ ;]+)/);
        //     return cookieValue ? cookieValue[1] : '';
        // }
                
            
        // // Setting up objs array to store canvas properties
        // window.metadataMap = new Map();
        

        // // assigning the background to variable
        // window.project_id = "{{ latest_upload_id|escapejs }}";

        // document.addEventListener("DOMContentLoaded", () => {

        //     //experimental
        //     window.currentBg = "{{ current_bg|escapejs }}";

        // });


        // // Call this when saving saveTextComponents
        // document.getElementById('saveTextBtn').addEventListener('click', saveTextComponents);

        // // function saveTextComponents() {
        // //     const canvasWrappers = document.querySelectorAll('.canvas-wrapper');
        // //     const visibleCanvases = [];
        // //     const project_id = "{{ latest_upload_id|escapejs }}";
            
        // //     // Filter only visible canvases
        // //     canvasWrappers.forEach(wrapper => {
        // //         if (window.getComputedStyle(wrapper).display !== 'none') {
        // //             const canvas = wrapper.querySelector('.rembg-canvas');
        // //             if (canvas) visibleCanvases.push(canvas);
        // //         }
        // //     });
            
        // //     // Prepare data with proper formatting
        // //     const elements = visibleCanvases.map(canvas => {
        // //         const meta = metadataMap.get(canvas);
                
        // //         // Get relative image path (remove domain and query params)
        // //         let imagePath = meta.imagePath;
        // //         if (imagePath.includes(window.location.origin)) {
        // //             imagePath = imagePath.replace(window.location.origin, '');
        // //         }
        // //         if (imagePath.includes('?')) {
        // //             imagePath = imagePath.split('?')[0];
        // //         }
                
        // //         return {
        // //             image_path: imagePath,
        // //             design_data: {
        // //                 header: {
        // //                     height: parseInt(meta.design_data.header.height) || 0,
        // //                     color: meta.design_data.header.color,
        // //                     opacity: parseFloat(meta.design_data.header.opacity) || 1.0
        // //                 },
        // //                 footer: {
        // //                     height: parseInt(meta.design_data.footer.height) || 0,
        // //                     color: meta.design_data.footer.color,
        // //                     opacity: parseFloat(meta.design_data.footer.opacity) || 1.0
        // //                 },
        // //                 //texts: meta.design_data.texts || [],
                        
        // //                 // new code for texts
        // //                 texts: (meta.design_data.texts || []).map(text => ({
        // //                     ...text,
        // //                     fontFamily: text.fontFamily || 'Arial' // Ensure fontFamily is included
        // //                 })),
        // //                 // end new code texts
                        
        // //                 // New Code
        // //                 logo_x: meta.design_data.logo_x,
        // //                 logo_y: meta.design_data.logo_y,
        // //                 logo_scale: meta.design_data.logo_scale,
        // //                 //logo_path: meta.design_data.logo_path,
        // //                 logo_opacity: meta.design_data.logo_opacity,
                        
        // //             }
        // //         };
        // //     });
            
        // //     const data = { 
        // //         project_id: project_id,
        // //         elements: elements 
        // //     };
            
        // //     console.log("Saving design data:", JSON.stringify(data, null, 2));

        // //     fetch('save_metadata', {
        // //         method: 'POST',
        // //         headers: {
        // //             'Content-Type': 'application/json',
        // //             'X-CSRFToken': getCSRFToken()
        // //         },
        // //         body: JSON.stringify(data)
        // //     })
        // //     .then(response => {
        // //         if (!response.ok) {
        // //             return response.json().then(err => { throw new Error(err.error || 'Failed to save design'); });
        // //         }
        // //         return response.json();
        // //     })
        // //     .then(data => {
        // //         console.log("Design saved:", data);
        // //         showError("Design saved successfully!", "green");
        // //     })
        // //     .catch(error => {
        // //         console.error("Error saving design:", error);
        // //         showError("Error saving design: " + error.message, "red");s
        // //     });
        // // }

        // // Add this function to rmbg.js
        // function saveTextComponents() {
        //     const visibleCanvases = Array.from(document.querySelectorAll('.rembg-canvas'))
        //         .filter(canvas => canvas.offsetParent !== null); // Get only visible canvases

        //     if (visibleCanvases.length === 0) {
        //         showError("No visible canvases found", "red");
        //         return;
        //     }

        //     const project_id = "{{ latest_upload_id|escapejs }}";
        //     const state = getCanvasStateDesign(); // Get current design state

        //     // Prepare the data to save
        //     const elements = visibleCanvases.map(canvas => {
        //         const meta = metadataMap.get(canvas);
                
        //         // Get relative image path
        //         let imagePath = meta.imagePath;
        //         if (imagePath.includes(window.location.origin)) {
        //             imagePath = imagePath.replace(window.location.origin, '');
        //         }
        //         imagePath = imagePath.split('?')[0];

        //         // Get logo path if exists
        //         let logoPath = '';
        //         if (state.logo && state.logo.image && state.logo.image.src) {
        //             logoPath = state.logo.image.src
        //                 .replace(window.location.origin, '')
        //                 .split('?')[0];
        //         }

        //         return {
        //             image_path: imagePath,
        //             design_data: {
        //                 header: state.header || {},
        //                 footer: state.footer || {},
        //                 texts: state.footer.texts || [],
        //                 logo_path: logoPath,
        //                 logo_x: state.logo.x || 100,
        //                 logo_y: state.logo.y || 100,
        //                 logo_scale: state.logo.scale || 0.1
        //             }
        //         };
        //     });

        //     const data = {
        //         project_id: project_id,
        //         elements: elements
        //     };

        //     console.log("Saving design data:", JSON.stringify(data, null, 2));

        //     fetch('save_metadata', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             'X-CSRFToken': getCSRFToken()
        //         },
        //         body: JSON.stringify(data)
        //     })
        //     .then(response => {
        //         if (!response.ok) {
        //             throw new Error('Failed to save design');
        //         }
        //         return response.json();
        //     })
        //     .then(data => {
        //         console.log("Design saved:", data);
        //         showError("Design saved successfully!", "green");
        //     })
        //     .catch(error => {
        //         console.error("Error saving design:", error);
        //         showError("Error saving design: " + error.message, "red");
        //     });
        // }
        // // Add this if not already present
        // function getCSRFToken() {
        //     const cookieValue = document.cookie.match(/csrftoken=([^ ;]+)/);
        //     return cookieValue ? cookieValue[1] : '';
        // }
        
        window.project_id = "{{ latest_upload_id|escapejs }}";
        // Setting up objs array to store canvas properties
        window.metadataMap = new Map();
        document.addEventListener("DOMContentLoaded", () => {

        //experimental
        window.currentBg = "{{ current_bg|escapejs }}";

        });

    </script>


<!--Load main preview js file-->
<script type="module" src="{% static 'main_preview/canvas_mouse.js' %}" defer></script>

<!-- Load Logo Properties JS File-->
<script type="module" src="{% static 'main_preview/logo_properties.js' %}" defer></script>

<!-- Load Header JS File-->
<script type="module" src="{% static 'main_preview/header.js' %}" defer></script>

<!-- Load Footer JS File-->
<script type="module" src="{% static 'main_preview/footer.js' %}" defer></script>

<!--load download zip js file-->
<script type="module" src="{% static 'main_preview/download_zip.js' %}" defer></script>

<!--load download zip js file-->
<script type="module" src="{% static 'main_preview/template.js' %}" defer></script>

<!--load logo_select.js file-->
<script type="module" src="{% static 'main_preview/logo_select.js' %}" defer></script>

<!--load rmbg_function.js file-->
<script type="module" src="{% static 'rmbg_function.js' %}" defer></script>


</body>
</html>